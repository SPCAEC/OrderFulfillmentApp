<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SPCA Order Fulfillment</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app">
    <header>
      <img
        src="https://drive.google.com/uc?export=view&id=1QdKdMM-VHas0xgrCFpP_cITMn2ZZx7hY"
        alt="SPCA Logo"
      />
      <h1>Order Fulfillment</h1>
    </header>

    <p class="desc">Scan a barcode or enter a 12-digit Form ID</p>

    <div class="card">
      <h2>Lookup</h2>

      <div class="preview" id="previewContainer">
        <video id="cameraPreview" autoplay playsinline></video>
        <button class="btn secondary" id="stopBtn">Cancel</button>
      </div>

      <button class="btn primary" id="startScanBtn">ðŸ“· Scan Barcode</button>

      <div class="input-row">
        <input id="formIdInput" placeholder="XXXXXXXXXXXX" maxlength="12" />
        <button class="btn primary" id="lookupBtn">Lookup</button>
      </div>

      <small class="tip">
        Tip: If your device doesnâ€™t support barcode scanning, enter the Form ID above.
      </small>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <h2>Confirm Label Printing</h2>
      <p>
        Printing these labels will also notify the client that their order is
        ready for pickup.
      </p>
      <div class="actions">
        <button class="btn secondary" id="cancelModalBtn">Cancel</button>
        <button class="btn primary" id="confirmModalBtn">Print Labels</button>
      </div>
    </div>
  </div>

  <script>
    const startScanBtn = document.getElementById("startScanBtn");
    const stopBtn = document.getElementById("stopBtn");
    const previewContainer = document.getElementById("previewContainer");
    const video = document.getElementById("cameraPreview");
    const formIdInput = document.getElementById("formIdInput");
    const lookupBtn = document.getElementById("lookupBtn");
    const modalBackdrop = document.getElementById("modalBackdrop");
    const cancelModalBtn = document.getElementById("cancelModalBtn");
    const confirmModalBtn = document.getElementById("confirmModalBtn");

    let stream = null;
    let barcodeDetector;

    if ("BarcodeDetector" in window) {
      barcodeDetector = new BarcodeDetector({ formats: ["code_128", "ean_13"] });
    } else {
      alert("BarcodeDetector API not supported in this browser.");
    }

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
        });
        video.srcObject = stream;
        previewContainer.style.display = "block";
        startScanBtn.style.display = "none";
        scanLoop();
      } catch (err) {
        alert("Camera access denied or not available.");
        console.error(err);
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach((track) => track.stop());
        stream = null;
      }
      previewContainer.style.display = "none";
      startScanBtn.style.display = "inline-block";
    }

    async function scanLoop() {
      if (!barcodeDetector || !stream) return;
      try {
        const result = await barcodeDetector.detect(video);
        if (result.length > 0) {
          const code = result[0].rawValue;
          console.log("Detected barcode:", code);
          stopCamera();
          formIdInput.value = code;
          openModal();
        }
      } catch (e) {
        console.warn("Scan error", e);
      }
      if (stream) requestAnimationFrame(scanLoop);
    }

    function openModal() {
      modalBackdrop.style.display = "flex";
    }

    function closeModal() {
      modalBackdrop.style.display = "none";
    }

    startScanBtn.addEventListener("click", startCamera);
    stopBtn.addEventListener("click", stopCamera);
    lookupBtn.addEventListener("click", openModal);
    cancelModalBtn.addEventListener("click", closeModal);

    confirmModalBtn.addEventListener("click", () => {
      closeModal();
      alert("Labels are being generated and the client will be notified.");
      // TODO: Integrate actual POST /generate-labels call here
    });
  </script>
</body>
</html>