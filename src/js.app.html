// Frontend controller for Pantry Order Fulfillment App
(() => {
  const $ = sel => document.querySelector(sel);
  const $$ = sel => [...document.querySelectorAll(sel)];

  const state = {
    formId: '',
    data: null,
    fleaChoice: null,
    count: null
  };

  const formIdInput = $('#formIdInput');
  const lookupBtn = $('#lookupBtn');
  const scanBtn = $('#scanBtn');
  const messageDiv = $('#message');
  const resultDiv = $('#result');
  const startOverBtn = $('#startOverBtn');

  // ─── UI helpers ──────────────────────────────────────────────
  function setMsg(text, type){
    messageDiv.classList.remove('error','success');
    if(type==='error') messageDiv.classList.add('error');
    if(type==='success') messageDiv.classList.add('success');
    messageDiv.innerHTML = text || '';
  }
  function spinner(text){ return `<span class="spinner"></span> <span>${text}</span>`; }
  const digits = s => String(s||'').replace(/\D/g,'');
  const toFormId = s => {
    const d = digits(s);
    return d.length >= 12 ? d.slice(-12) : d.padStart(12,'0');
  };

  function resetUI(){
    state.formId=''; state.data=null; state.fleaChoice=null; state.count=null;
    formIdInput.value=''; formIdInput.disabled=false; formIdInput.focus();
    lookupBtn.disabled=true; lookupBtn.style.display='';
    scanBtn.disabled=false; scanBtn.style.display='';
    resultDiv.innerHTML=''; setMsg('');
  }
  startOverBtn.onclick = resetUI;

  // Smooth scroll (after layout settles)
  function scrollAfterLayout(el, block = 'center') {
    if (!el) return;
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        el.scrollIntoView({ behavior: 'smooth', block });
      });
    });
  }

  // ─── Input events ────────────────────────────────────────────
  formIdInput.addEventListener('input', () => {
    formIdInput.value = digits(formIdInput.value);
    lookupBtn.disabled = formIdInput.value.trim() === '';
  });
  formIdInput.addEventListener('blur', () => {
    if (formIdInput.value) formIdInput.value = toFormId(formIdInput.value);
  });
  formIdInput.addEventListener('keydown', e => {
    if(e.key==='Enter' && !lookupBtn.disabled){
      e.preventDefault();
      formIdInput.value = toFormId(formIdInput.value);
      lookupBtn.click();
    }
  });

  // ─── Barcode scan using native API ───────────────────────────
  async function startScan(){
    if (!('BarcodeDetector' in window)) {
      setMsg('BarcodeDetector not supported. Use manual entry.', 'error');
      return;
    }
    try {
      const detector = new BarcodeDetector({ formats:['code_128','ean_13','upc_a'] });
      const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } });

      resultDiv.innerHTML = `
        <div class="card camera">
          <video id="scanVideo" autoplay playsinline></video>
          <div class="actions" style="margin-top:.5rem">
            <button id="cancelScanBtn" class="btn ghost">Cancel</button>
          </div>
        </div>`;
      const videoEl = $('#scanVideo');
      videoEl.srcObject = stream;

      // Auto-scroll when video is ready
      videoEl.onloadedmetadata = () => {
        scrollAfterLayout(videoEl, 'start');
      };

      $('#cancelScanBtn').onclick = () => {
        stream.getTracks().forEach(t=>t.stop());
        resultDiv.innerHTML=''; setMsg('Scan canceled.');
        scanBtn.disabled=false;
      };

      scanBtn.disabled=true; setMsg('Point camera at barcode…');

      const interval = setInterval(async () => {
        try {
          const codes = await detector.detect(videoEl);
          if (codes.length) {
            clearInterval(interval);
            stream.getTracks().forEach(t=>t.stop());
            const id = toFormId(codes[0].rawValue);
            formIdInput.value = id;
            lookupBtn.disabled=false;
            resultDiv.innerHTML='';
            setMsg('Scan successful!','success');
            lookupBtn.click();
          }
        } catch(_) {}
      }, 400);

    } catch(err){
      console.error(err);
      setMsg('Camera error. Use manual entry.','error');
    }
  }
  scanBtn.addEventListener('click', startScan);

  // ─── Lookup flow ─────────────────────────────────────────────
  lookupBtn.addEventListener('click', () => {
    if (!formIdInput.value){ setMsg('Please enter a Form ID.','error'); return; }
    const id = toFormId(formIdInput.value);
    formIdInput.value = id;
    state.formId = id;

    setMsg(spinner('Looking up order…'));
    lookupBtn.disabled=true; formIdInput.disabled=true; resultDiv.innerHTML='';

    google.script.run
      .withSuccessHandler(renderLookup)
      .withFailureHandler(err => {
        console.error(err); setMsg('Server error during lookup.','error');
        lookupBtn.disabled=false; formIdInput.disabled=false;
      })
      .apiLookup(id);
  });

  // ─── Render lookup results ───────────────────────────────────
  function renderLookup(resp){
    if (!resp.ok){
      setMsg(resp.message || 'Order not found','error');
      lookupBtn.disabled=false; formIdInput.disabled=false;
      return;
    }
    state.data = resp;

    // Build info card
    let html = `<div class="card"><h2 style="margin:.25rem 0">${resp.fullName}</h2>`;
    html += `<p style="margin:.25rem 0"><strong>Date:</strong> ${resp.requestDatePretty || ''}</p>`;
    html += `<p style="margin:.25rem 0"><strong>Pickup Window:</strong> ${resp.pickupWindow || ''}</p>`;

    if (resp.alerts && resp.alerts.length){
      html += `<div style="margin-top:.5rem"><strong style="color:red">Reminders/Alerts:</strong><ul>`;
      resp.alerts.forEach(a => html += `<li style="color:red;font-weight:bold">${a}</li>`);
      html += `</ul></div>`;
    }

    // Flea flow
    const showFlea = (resp.additionalServices || []).includes('Flea prevention');
    if (showFlea && FLEA_FLOW_ENABLED){
      html += `
        <div class="card" style="margin-top:1rem">
          <p><strong>Flea Medication:</strong> Did you include flea prevention in this order?</p>
          <div class="actions">
            <button id="fleaYes" class="btn">✅ Yes</button>
            <button id="fleaNo" class="btn secondary">❌ No</button>
          </div>
          <div id="fleaMsg" class="msg"></div>
        </div>`;
    }

    // Label count buttons
    html += `<div class="card" style="margin-top:1rem">
      <p><strong>How many labels?</strong></p>
      <div class="actions" id="labelButtons">
        ${[1,2,3,4,5].map(n=>`<button class="btn" data-count="${n}">${n} Label${n>1?'s':''}</button>`).join('')}
      </div>
      <div id="labelMsg" class="msg"></div>
    </div>`;

    resultDiv.innerHTML = html; setMsg('');

    // Auto-scroll to client info card
    scrollAfterLayout(resultDiv, 'start');

    // Hook flea buttons
    if (showFlea && FLEA_FLOW_ENABLED){
      $('#fleaYes').onclick = () => { state.fleaChoice=true; $('#fleaMsg').textContent='Selected YES'; };
      $('#fleaNo').onclick = () => { state.fleaChoice=false; $('#fleaMsg').textContent='Selected NO'; };
    } else {
      state.fleaChoice=null; // not required
    }

    // Hook label buttons
    $$('#labelButtons .btn').forEach(btn=>{
      btn.onclick = () => {
        const count = Number(btn.dataset.count);
        if (showFlea && FLEA_FLOW_ENABLED && state.fleaChoice===null){
          $('#labelMsg').textContent='Please choose a flea medication option first';
          $('#labelMsg').classList.add('error');
          return;
        }
        state.count = count;
        confirmLabels();
      };
    });
  }

  // ─── Confirm modal ───────────────────────────────────────────
  function confirmLabels(){
    const modal = document.createElement('div');
    modal.style.position='fixed'; modal.style.top=0; modal.style.left=0; modal.style.width='100%'; modal.style.height='100%';
    modal.style.background='rgba(0,0,0,0.6)'; modal.style.display='flex'; modal.style.alignItems='center'; modal.style.justifyContent='center';
    modal.innerHTML = `
      <div class="card" style="max-width:400px;text-align:center;background:white">
        <h3>ATTENTION</h3>
        <p>By printing these labels you will be notifying the client that their order is ready for pickup.</p>
        <div class="actions">
          <button id="confirmYes" class="btn" style="background:#16a34a">YES, Notify</button>
          <button id="confirmNo" class="btn secondary" style="background:#dc2626;color:white">NO, Cancel</button>
        </div>
      </div>`;
    document.body.appendChild(modal);

    $('#confirmYes').onclick = () => {
      document.body.removeChild(modal);
      generateLabels();
    };
    $('#confirmNo').onclick = () => {
      document.body.removeChild(modal);
    };
  }

  // ─── Generate labels ─────────────────────────────────────────
  function generateLabels(){
    setMsg(spinner('Creating labels…'));
    resultDiv.innerHTML='';

    google.script.run
      .withSuccessHandler(res => {
        if (!res.ok){
          setMsg(res.message || 'Label creation failed','error');
          return;
        }
        setMsg('Labels created!','success');
        resultDiv.innerHTML = `
          <div class="card">
            <p><a href="${res.url}" target="_blank" rel="noopener">Open PDF for printing</a></p>
            <button id="nextBtn" class="btn startover" style="margin-top:1rem">Scan Next Form</button>
          </div>`;
        $('#nextBtn').onclick = resetUI;

        // Auto-scroll to label result
        scrollAfterLayout(resultDiv, 'start');

        // 🔽 Auto-trigger download/open
        const link = document.createElement('a');
        link.href = res.url;
        link.download = res.name || 'BagLabels.pdf'; // fallback if no name
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      })
      .withFailureHandler(err => {
        console.error(err); setMsg('Server error creating labels','error');
      })
      .apiGenerateLabels(state.formId, state.count, state.fleaChoice);
  }

})();